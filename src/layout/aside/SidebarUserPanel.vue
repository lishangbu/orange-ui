<script setup lang="ts">
import { useMessage } from 'naive-ui'
import { computed, onMounted, ref } from 'vue'

import { ButtonAnimation } from '@/components'
import Avatar from '@/components/UserAvatar.vue'
import UserDropdown from '@/components/UserDropdown.vue'
import { toRefsPreferencesStore, useUserStore } from '@/stores'

import type { User } from '@/types/modules/user'

const { sidebarMenu } = toRefsPreferencesStore()

const { getUserInfo } = useUserStore()
const user = ref<User | null>(null)

const userRoleNames = computed(() => {
  return user.value?.roles?.map(role => role.name).join(', ') || ''
})

const username = computed(() => {
  return user.value?.username || ''
})

const message = useMessage()

const handleUserPanelClick = () => {
  message.info('你可以把它设计成有背景的User Card')
}
onMounted(() => {
  getUserInfo().then(userInfo => {
    user.value = userInfo
  })
})
</script>
<template>
  <div
    class="flex cursor-pointer items-center transition-[background-color,border-radius,margin,padding] hover:bg-neutral-200/90 dark:hover:bg-neutral-750/65"
    :class="
      sidebarMenu.collapsed
        ? 'mx-2 rounded-naive px-2 py-1.5'
        : 'mx-4 rounded-xl bg-neutral-150 py-3.5 pr-2.5 pl-3.5 dark:bg-neutral-800'
    "
    @click="handleUserPanelClick"
  >
    <UserDropdown
      placement="right-end"
      :disabled="!sidebarMenu.collapsed"
    >
      <div
        class="grid place-items-center overflow-hidden rounded-full transition-[margin]"
        :class="{
          'mr-2': !sidebarMenu.collapsed,
        }"
      >
        <div
          class="flex items-center justify-center overflow-hidden transition-[height,width]"
          :class="sidebarMenu.collapsed ? 'size-8' : 'size-10'"
        >
          <Avatar
            size="large"
            class="aspect-square"
            style="height: unset"
          />
        </div>
      </div>
    </UserDropdown>
    <Transition
      type="transition"
      enter-active-class="transition-[grid-template-columns] duration-150"
      leave-active-class="transition-[grid-template-columns] duration-150"
      enter-from-class="grid-cols-[0fr]"
      leave-to-class="grid-cols-[0fr]"
      enter-to-class="grid-cols-[1fr]"
      leave-from-class="grid-cols-[1fr]"
    >
      <div
        class="flex flex-1 items-center justify-between overflow-hidden"
        v-show="!sidebarMenu.collapsed"
      >
        <div class="flex flex-col gap-y-px overflow-hidden">
          <span class="truncate text-sm">
              {{ username }}
            </span>
          <span class="truncate text-xs text-neutral-450 dark:text-neutral-500">
              {{ userRoleNames }}
      </span>
        </div>

        <UserDropdown placement="top">
          <ButtonAnimation
            animation="rotate"
            title="设置"
          >
            <span class="iconify text-neutral-500 ph--gear dark:text-neutral-450" />
          </ButtonAnimation>
        </UserDropdown>
      </div>
    </Transition>
  </div>
</template>
